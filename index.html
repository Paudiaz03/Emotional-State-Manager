<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detector de Emociones</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080810;
    --text: #e8e8f0;
    --text-dim: #4a4a6a;
    --c1: #4a9eff;
    --c2: #a78bfa;
    --c3: #4a9eff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3rem;
    overflow: hidden;
  }

  /* ——— ORB ——— */
  .orb-wrapper {
    position: relative;
    width: 220px;
    height: 220px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  /* Ondas externas */
  .ring {
    position: absolute;
    border-radius: 50%;
    border: 1px solid rgba(74, 158, 255, 0.15);
    animation: ring-idle 3s ease-in-out infinite;
  }

  .ring-1 { width: 180px; height: 180px; animation-delay: 0s; }
  .ring-2 { width: 200px; height: 200px; animation-delay: 0.4s; }
  .ring-3 { width: 220px; height: 220px; animation-delay: 0.8s; }

  @keyframes ring-idle {
    0%, 100% { transform: scale(1); opacity: 0.4; }
    50% { transform: scale(1.04); opacity: 0.15; }
  }

  /* Estado grabando */
  .orb-wrapper.recording .ring {
    animation: ring-record 1s ease-in-out infinite;
    border-color: rgba(255, 80, 80, 0.4);
  }

  @keyframes ring-record {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.08); opacity: 0.2; }
  }

  /* Estado procesando */
  .orb-wrapper.processing .ring {
    animation: ring-process 0.8s ease-in-out infinite;
    border-color: rgba(167, 139, 250, 0.5);
  }

  @keyframes ring-process {
    0% { transform: rotate(0deg) scale(1); }
    100% { transform: rotate(360deg) scale(1); }
  }

  /* La bolita */
  .orb {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    position: relative;
    transition: transform 0.3s ease;
    background: radial-gradient(circle at 35% 35%, #6ab8ff, #1a6fcc 50%, #0a2a6e);
    box-shadow:
      0 0 40px rgba(74, 158, 255, 0.4),
      0 0 80px rgba(74, 158, 255, 0.15),
      inset 0 0 30px rgba(0, 0, 0, 0.3);
  }

  .orb::before {
    content: '';
    position: absolute;
    top: 15%;
    left: 20%;
    width: 35%;
    height: 25%;
    background: radial-gradient(ellipse, rgba(255,255,255,0.5), transparent);
    border-radius: 50%;
    filter: blur(4px);
  }

  /* Blob animado dentro */
  .orb::after {
    content: '';
    position: absolute;
    inset: 10%;
    border-radius: 50%;
    background: radial-gradient(circle at 60% 40%, rgba(167,139,250,0.6), transparent 60%);
    animation: blob-float 4s ease-in-out infinite;
  }

  @keyframes blob-float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(8px, -8px) scale(1.1); }
    66% { transform: translate(-6px, 6px) scale(0.95); }
  }

  .orb-wrapper:hover .orb { transform: scale(1.05); }

  /* Colores por emoción */
  .orb-wrapper.recording .orb {
    background: radial-gradient(circle at 35% 35%, #ff8080, #cc2020 50%, #6e0a0a);
    box-shadow: 0 0 40px rgba(255,60,60,0.5), 0 0 80px rgba(255,60,60,0.2), inset 0 0 30px rgba(0,0,0,0.3);
  }

  .orb-wrapper.processing .orb {
    background: radial-gradient(circle at 35% 35%, #c4b5fd, #7c3aed 50%, #2e1065);
    box-shadow: 0 0 40px rgba(167,139,250,0.5), 0 0 80px rgba(167,139,250,0.2), inset 0 0 30px rgba(0,0,0,0.3);
    animation: orb-spin 2s linear infinite;
  }

  @keyframes orb-spin {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
  }

  .orb-wrapper.emotion-odio .orb {
    background: radial-gradient(circle at 35% 35%, #ff8080, #cc2020 50%, #6e0a0a);
    box-shadow: 0 0 50px rgba(255,60,60,0.6), 0 0 100px rgba(255,60,60,0.2), inset 0 0 30px rgba(0,0,0,0.3);
  }

  .orb-wrapper.emotion-tristeza .orb {
    background: radial-gradient(circle at 35% 35%, #6ab8ff, #1a6fcc 50%, #0a2a6e);
    box-shadow: 0 0 50px rgba(74,158,255,0.6), 0 0 100px rgba(74,158,255,0.2), inset 0 0 30px rgba(0,0,0,0.3);
  }

  .orb-wrapper.emotion-felicidad .orb {
    background: radial-gradient(circle at 35% 35%, #ffe066, #e6a800 50%, #6e4a00);
    box-shadow: 0 0 50px rgba(255,210,60,0.6), 0 0 100px rgba(255,210,60,0.2), inset 0 0 30px rgba(0,0,0,0.3);
  }

  /* Ondas de audio (grabando) */
  .audio-waves {
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 3px;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .orb-wrapper.recording .audio-waves { opacity: 1; }

  .audio-bar {
    width: 3px;
    background: rgba(255, 100, 100, 0.7);
    border-radius: 2px;
    animation: audio-wave 0.8s ease-in-out infinite;
    height: 6px;
  }

  .audio-bar:nth-child(1) { animation-delay: 0s; }
  .audio-bar:nth-child(2) { animation-delay: 0.08s; }
  .audio-bar:nth-child(3) { animation-delay: 0.16s; }
  .audio-bar:nth-child(4) { animation-delay: 0.24s; }
  .audio-bar:nth-child(5) { animation-delay: 0.32s; }
  .audio-bar:nth-child(6) { animation-delay: 0.24s; }
  .audio-bar:nth-child(7) { animation-delay: 0.16s; }
  .audio-bar:nth-child(8) { animation-delay: 0.08s; }
  .audio-bar:nth-child(9) { animation-delay: 0s; }

  @keyframes audio-wave {
    0%, 100% { height: 4px; }
    50% { height: 20px; }
  }

  /* ——— TEXTO ——— */
  .status-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.6rem;
    text-align: center;
  }

  .emotion-label {
    font-size: 2.4rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.5s ease, transform 0.5s ease, color 0.5s ease;
    color: #4a9eff;
    min-height: 3rem;
  }

  .emotion-label.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .emotion-label.odio { color: #ff4444; }
  .emotion-label.tristeza { color: #4a9eff; }
  .emotion-label.felicidad { color: #ffd93d; }

  .status-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.12em;
    color: var(--text-dim);
    text-transform: uppercase;
    transition: color 0.3s;
  }

  .status-text.recording { color: rgba(255,80,80,0.7); }
  .status-text.processing { color: rgba(167,139,250,0.7); }
  .status-text.done { color: rgba(74,158,255,0.7); }
  .status-text.error { color: rgba(255,80,80,0.7); }

  /* ——— HINT ——— */
  .hint {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--text-dim);
    letter-spacing: 0.08em;
    opacity: 0.6;
  }

  /* ——— COMPAT ——— */
  .compat-warning {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: rgba(255,80,80,0.8);
    text-align: center;
    line-height: 1.8;
    display: none;
  }

  .compat-warning.visible { display: block; }

  /* Fondo ambiental */
  .ambient {
    position: fixed;
    inset: 0;
    pointer-events: none;
    transition: background 2s ease;
  }

  .ambient.emotion-odio {
    background: radial-gradient(ellipse at center, rgba(255,40,40,0.06) 0%, transparent 70%);
  }

  .ambient.emotion-tristeza {
    background: radial-gradient(ellipse at center, rgba(74,158,255,0.06) 0%, transparent 70%);
  }

  .ambient.emotion-felicidad {
    background: radial-gradient(ellipse at center, rgba(255,210,60,0.07) 0%, transparent 70%);
  }
</style>
</head>
<body>

<div class="ambient" id="ambient"></div>

<div class="compat-warning" id="compatWarning">
  ⚠ Usa Chrome o Edge para el reconocimiento de voz
</div>

<div class="orb-wrapper" id="orbWrapper" onclick="toggleRecording()">
  <div class="ring ring-1"></div>
  <div class="ring ring-2"></div>
  <div class="ring ring-3"></div>
  <div class="orb"></div>
  <div class="audio-waves">
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
  </div>
</div>

<div class="status-area">
  <div class="emotion-label" id="emotionLabel">—</div>
  <p class="status-text" id="statusText">Toca para hablar</p>
</div>



<script>
  const WEBHOOK_URL = 'https://pdiazd.app.n8n.cloud/webhook/655382b9-db63-49a4-9257-7df5eebed9cf';

  let recognition = null;
  let isRecording = false;
  let finalTranscript = '';
  let interimTranscript = '';

  const orbWrapper = document.getElementById('orbWrapper');
  const emotionLabel = document.getElementById('emotionLabel');
  const statusText = document.getElementById('statusText');
  const ambient = document.getElementById('ambient');
  const compatWarning = document.getElementById('compatWarning');

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    compatWarning.classList.add('visible');
    orbWrapper.style.pointerEvents = 'none';
    orbWrapper.style.opacity = '0.4';
  }

  function setupRecognition() {
    recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.interimResults = true;
    recognition.continuous = true;

    recognition.onresult = (event) => {
      finalTranscript = '';
      interimTranscript = '';
      for (let i = 0; i < event.results.length; i++) {
        if (event.results[i].isFinal) {
          finalTranscript += event.results[i][0].transcript + ' ';
        } else {
          interimTranscript += event.results[i][0].transcript;
        }
      }
    };

    recognition.onerror = (event) => {
      if (event.error === 'no-speech') return;
      setStatus('Error: ' + event.error, 'error');
      stopRecording(false);
    };

    recognition.onend = () => {
      if (isRecording) recognition.start();
    };
  }

  function toggleRecording() {
    if (!SpeechRecognition) return;
    if (!isRecording) startRecording();
    else stopRecording(true);
  }

  function startRecording() {
    finalTranscript = '';
    interimTranscript = '';
    setupRecognition();
    recognition.start();
    isRecording = true;

    orbWrapper.className = 'orb-wrapper recording';
    emotionLabel.classList.remove('visible');
    ambient.className = 'ambient';
    setStatus('Escuchando...', 'recording');
  }

  function stopRecording(sendData) {
    isRecording = false;
    if (recognition) recognition.stop();
    orbWrapper.classList.remove('recording');

    if (!sendData) return;

    const text = finalTranscript.trim() || interimTranscript.trim();

    if (!text) {
      setStatus('No detecté nada. Intenta de nuevo.', 'error');
      orbWrapper.className = 'orb-wrapper';
      return;
    }

    orbWrapper.className = 'orb-wrapper processing';
    setStatus('Analizando...', 'processing');
    sendToN8n(text);
  }

  async function sendToN8n(transcript) {
    try {
      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json, text/plain, */*'
        },
        body: JSON.stringify({ transcript })
      });

      const raw = await response.text();
      let data;
      try { data = JSON.parse(raw); } catch { data = { text: raw.trim() }; }
      showResult(data);

    } catch (err) {
      orbWrapper.className = 'orb-wrapper';
      setStatus('Error de conexión', 'error');
      console.error('Error:', err);
    }
  }

  function showResult(data) {
    let emotion = '';

    if (typeof data === 'string') emotion = data;
    else if (data.text) emotion = data.text;
    else if (data.emotion) emotion = data.emotion;
    else if (data.output) emotion = data.output;

    emotion = emotion.replace(/[^a-záéíóúñ]/gi, '').toLowerCase().trim();

    const validEmotions = ['odio', 'tristeza', 'felicidad'];
    const matched = validEmotions.find(e => emotion.includes(e)) || null;

    orbWrapper.className = 'orb-wrapper' + (matched ? ' emotion-' + matched : '');
    ambient.className = 'ambient' + (matched ? ' emotion-' + matched : '');

    emotionLabel.className = 'emotion-label' + (matched ? ' ' + matched : '');
    emotionLabel.textContent = matched ? matched.toUpperCase() : '?';
    setTimeout(() => emotionLabel.classList.add('visible'), 50);

    setStatus('Toca para volver a hablar', 'done');
  }

  function setStatus(msg, type) {
    statusText.textContent = msg;
    statusText.className = 'status-text' + (type ? ' ' + type : '');
  }
</script>
</body>
</html>
